# VGM_MUSIC
### An attempt at writing a music composition tool for the YM2151 in python

Hello!  As you look through this, please keep in mind that it was one of, if not the, first code I wrote that wasn't a one-file shell or python script.

## What is this?

In early 2019, a friend was writing a game engine for the [Commander X16](https://www.commanderx16.com/forum/index.php?/home/).  He was developing a small game alongside it as part of the engine development and asked me if I wanted to compose music and sound effects for it.  I said "yes", but there was one catch: at the time, the Commander X16 used only the [YM2151](https://en.wikipedia.org/wiki/Yamaha_YM2151) and I had never programmed for a microcontroller before.  Still, it seemed fun so I hopped in and began writing this code.  Development stopped in mid-late 2019.

## What does it do?

It has several utilities:
* `sequencer.py`contains the following classes:
    * *Step* (represents one subdivision of a measure)
    * *Pattern* (a virtually unlimited length sequence of steps)
    * *Sequence* (a virtually unlimited length sequence of patterns)
* `instrument.py` contains the following class:
    * *Instrument* (instrument definitions for the [YM2151](https://en.wikipedia.org/wiki/Yamaha_YM2151))
* `convert_mid.py` is used to convert midi files generated by midi-ox into commands for the YM2151
* `convert_dmp.py` is used to convert .dmp instruments to .spi
* `convert_opm.py` is used to convert .opm instruments to .spi

## How do I use it?

For now, you don't.  It's currently non-functional and doesn't work well anyway.  

How it *did* work at one time was:

1) Create a script such as the ones in `songs/`
2) Run said script

Essentially, you create some `Steps`, then some `Patterns` to hold them and then put the patterns in a `Sequencer` before finally calling `to_spt()` on your `Sequencer`.  Right now, it doesn't produce an output file, but that is what it was intended to do.

## Glossary

**sp**: file extension for binary files to be fed to YM2151
    * Stands for "Star Path", an old music alias of mine
        * Yes, yes, it's not a useful name\
    * none of this code directly deals with .sp files, see [x16-music-player](https://github.com/jjbliss/x16-music-player) instead

**spt**: file extenstion for "SP Textfile"
    * Is output from 
    * Each line *must* have:
        * An integer representing the YM2151 command followed by a comma
        * An integer representing the value for the command
    * Each line *can* have:
        * A comment, delimited by a semicolon after any commands or data

**spi**: file extenstion for "SP Instrument"
    * An instrument is really just a series of commands send to the YM2151 which configures its operators and modulators.
    * Each line *must* have:
        * An integer representing the YM2151 command followed by a comma
        * An integer representing the value for the command
    * Each line *can* have:
        * A comment, delimited by a semicolon after any commands or data

## Data examples

#### spt file with comments

``` 
12	; write six things to YM2151
32,	215	; write $D7 to reg $20
40,	80	; write $50 to reg $28
96,	7	; write $07 to reg $60
128,24	; write $18 to reg $80
224,5	; write $05 to reg $E0
8,	8	; write $08 to reg $08
33,	215	; now set up channel 1
41,	80
97,	7
129,24
225,5
8,	9
10	; wait 10 frames
1	; read 1 command
40, 244 ; write 244 to reg 40
10	; wait 10 frames
1	; read 1 command
40, 100 ; write 100 to reg 40
10	; wait 10 frames
```

#### midi file from midi-ox 

```
schema: timestamp, on/off, channel, note, velocity

0 On   ch=1 n=48 v=91
0 On   ch=11 n=41 v=123
0 On   ch=12 n=48 v=101
0 On   ch=13 n=81 v=125
1 On   ch=14 n=57 v=97
14 Off  ch=12 n=48 v=101
15 Off  ch=14 n=57 v=97
28 Off  ch=1 n=48 v=91
30 On   ch=12 n=52 v=110
30 On   ch=14 n=60 v=31
```



## References and Resources

* YM2151 original manual: http://map.grauw.nl/resources/sound/yamaha_ym2151_synthesis.pdf
* YM2151 Registers: https://w.atwiki.jp/mxdrv/pages/24.html
* Commander X16 programmer's guide: https://github.com/commanderx16/x16-docs/blob/master/Commander%20X16%20Programmer's%20Reference%20Guide.md
* VGM file format: http://www.smspower.org/Music/VGMFileFormat 


### External tools

* Music player for Commander X16: https://github.com/jjbliss/x16-music-player
    * has utilities
* Commander X16 emulator in a browser: https://x16.io
* Commander X16 emulator binaries: https://www.commanderx16.com/forum/files/
* Commander X16 on github: https://github.com/commanderx16